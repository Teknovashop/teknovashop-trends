---
import Base from "@/layouts/Base.astro";
import Reviews from "@/components/Reviews.astro";

// Slug desde la ruta dinámica
const { slug } = Astro.params as { slug: string };

// Cargamos TODOS los .md de contenido (trends/news, etc.)
const mdModules = import.meta.glob('../../content/**/*.md', { eager: true });

// Buscamos el que tenga frontmatter.slug === slug
let entry: any = null;
for (const [_, mod] of Object.entries(mdModules)) {
  const fm = (mod as any).frontmatter || (mod as any).metadata;
  if (fm?.slug === slug) {
    entry = mod;
    break;
  }
}

if (!entry) {
  throw new Error(`Producto no encontrado: ${slug}`);
}

const frontmatter = entry.frontmatter || entry.metadata;
const Content = entry.default;

const pageTitle = frontmatter?.title || 'Producto';
const hero = frontmatter?.hero || '/placeholder.jpg';
const niche = frontmatter?.niche || 'producto';
const score = typeof frontmatter?.score !== 'undefined' ? frontmatter.score : null;
const dateStr = frontmatter?.date ? new Date(frontmatter.date).toLocaleDateString('es-ES') : '';
---

<Base title={`Teknovashop · ${pageTitle}`} description={pageTitle}>
  <article class="wrap">
    <figure class="hero-wrap">
      <img class="hero" src={hero} alt={pageTitle} loading="eager" />
    </figure>

    <header class="head">
      <h1>{pageTitle}</h1>
      <div class="meta">
        <span class="badge">{niche}</span>
        {score !== null && <small>score {String(score)}</small>}
        {dateStr && <small>{dateStr}</small>}
      </div>
    </header>

    <div class="content">
      <Content />
    </div>

    <!-- Reseñas reales -->
    <section class="reviews-block">
      <Reviews slug={frontmatter.slug} title={pageTitle} />
    </section>
  </article>

  <style>
    .wrap{ max-width: 980px; margin: 0 auto; padding: 1rem; }
    .hero-wrap{ margin: 0 0 1rem; }
    .hero{ width:100%; height: 360px; object-fit: cover; border-radius: 16px; display:block; }
    .head h1{ margin:.4rem 0 .2rem; line-height:1.2; }
    .meta{ display:flex; gap:.7rem; align-items:center; color:#6b7280; flex-wrap:wrap; }
    .badge{ background:#e6f7fb; color:#04748b; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; font-weight:700 }
    .content :global(p){ margin:.8rem 0; }
    .content :global(ul){ margin:.6rem 0 .9rem 1.2rem; }
    .content :global(h2){ margin:1.2rem 0 .4rem; }
    .reviews-block{ margin-top: 2rem; }
    @media (max-width: 640px){
      .hero{ height: 220px; }
    }
  </style>
</Base>
