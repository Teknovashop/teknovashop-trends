---
import Base from "@/layouts/Base.astro";
import Reviews from "@/components/Reviews.astro";

/** 
 * Enumeramos todos los .md que tengan frontmatter.slug para generar páginas
 * como /producto/<slug>
 */
export async function getStaticPaths() {
  const modules = import.meta.glob('../../content/**/*.md', { eager: true });

  const paths: any[] = [];
  for (const [_p, mod] of Object.entries(modules)) {
    const fm = (mod as any).frontmatter || (mod as any).metadata;
    if (fm?.slug) {
      paths.push({
        params: { slug: fm.slug },
        props: { entry: mod }, // Pasamos el módulo para no volver a resolverlo
      });
    }
  }
  return paths;
}

// Recibimos el módulo markdown ya resuelto desde getStaticPaths
const { entry } = Astro.props as any;
if (!entry) {
  throw new Error('Entrada no encontrada para este slug');
}

const frontmatter = entry.frontmatter || entry.metadata;
const Content = entry.default;

const pageTitle = frontmatter?.title || 'Producto';
const hero = frontmatter?.hero || '/placeholder.jpg';
const niche = frontmatter?.niche || 'producto';
const score = typeof frontmatter?.score !== 'undefined' ? frontmatter.score : null;
const dateStr = frontmatter?.date ? new Date(frontmatter.date).toLocaleDateString('es-ES') : '';
---

<Base title={`Teknovashop · ${pageTitle}`} description={pageTitle}>
  <article class="wrap">
    <figure class="hero-wrap">
      <img class="hero" src={hero} alt={pageTitle} loading="eager" />
    </figure>

    <header class="head">
      <h1>{pageTitle}</h1>
      <div class="meta">
        <span class="badge">{niche}</span>
        {score !== null && <small>score {String(score)}</small>}
        {dateStr && <small>{dateStr}</small>}
      </div>
    </header>

    <div class="content">
      <Content />
    </div>

    <!-- Reseñas reales -->
    <section class="reviews-block">
      <Reviews slug={frontmatter.slug} title={pageTitle} />
    </section>
  </article>

  <style>
    .wrap{ max-width: 980px; margin: 0 auto; padding: 1rem; }
    .hero-wrap{ margin: 0 0 1rem; }
    .hero{ width:100%; height: 360px; object-fit: cover; border-radius: 16px; display:block; }
    .head h1{ margin:.4rem 0 .2rem; line-height:1.2; }
    .meta{ display:flex; gap:.7rem; align-items:center; color:#6b7280; flex-wrap:wrap; }
    .badge{ background:#e6f7fb; color:#04748b; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; font-weight:700 }
    .content :global(p){ margin:.8rem 0; }
    .content :global(ul){ margin:.6rem 0 .9rem 1.2rem; }
    .content :global(h2){ margin:1.2rem 0 .4rem; }
    .reviews-block{ margin-top: 2rem; }
    @media (max-width: 640px){
      .hero{ height: 220px; }
    }
  </style>
</Base>
