---
import Base from "@/layouts/Base.astro";
import fs from "fs";
import path from "path";

const ROOT = Astro.config.root?.pathname ?? process.cwd();

// Busca el último índice de productos
function findLatestProducts() {
  const base = path.join(ROOT, "src", "data", "trends");
  if (!fs.existsSync(base)) return null;
  const years = fs.readdirSync(base).sort().reverse();
  for (const y of years) {
    const ydir = path.join(base, y);
    const months = fs.readdirSync(ydir).sort().reverse();
    for (const m of months) {
      const mdir = path.join(ydir, m);
      const days = fs.readdirSync(mdir).sort().reverse();
      for (const d of days) {
        const idx = path.join(mdir, d, "index.json");
        if (fs.existsSync(idx)) {
          try { return JSON.parse(fs.readFileSync(idx, "utf-8")); }
          catch { /* ignore */ }
        }
      }
    }
  }
  return null;
}

const data = findLatestProducts();
const items = data?.items || [];
---

<Base title="Tendencias de hoy · Teknovashop" description="Selección curada de productos inteligentes en español. Mini-reviews y enlaces para comparar precios.">
  <h1>Tendencias de hoy</h1>
  <p class="lead">Selección curada en español. Clic en cada tarjeta para ver mini-review y enlaces de comparación.</p>

  {items.length === 0 ? (
    <p>No hay destacados todavía. Vuelve más tarde.</p>
  ) : (
    <div class="grid">
      {items.map(it => (
        <a class="card" href={`/producto/${it.slug}/`}>
          <img src={it.hero} alt={it.title} loading="lazy" />
          <div class="meta">
            <span class="badge">{it.niche || 'tecnología'}</span>
          </div>
          <h3>{it.title}</h3>
          <small>score {it.score || 1}</small>
        </a>
      ))}
    </div>
  )}

  <style>
    .lead{ color:#475569; margin:.3rem 0 1rem }
    .grid{ display:grid; gap:1rem; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); }
    .card{ display:block; background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:12px; text-decoration:none; color:#0f172a; }
    .card:hover{ border-color:#94a3b8; box-shadow:0 6px 24px rgba(2,6,23,.06); }
    .card img{ width:100%; height:160px; object-fit:cover; border-radius:12px; }
    .badge{ font-size:.75rem; background:#e2f3f2; color:#0b7a77; padding:.2rem .5rem; border-radius:999px; }
  </style>
</Base>
