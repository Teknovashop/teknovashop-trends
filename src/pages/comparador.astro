---
import Base from "@/layouts/Base.astro";

const title = "Comparador de precios (informativo)";
const description = "Busca un producto y te mostramos dónde encontrarlo por país. Enlaces informativos, sin afiliación.";
---

<Base {title} {description}>
  <section class="wrap">
    <h1>Comparador de precios (informativo)</h1>
    <p class="small">
      Escribe un producto (mejor con marca y modelo) y elige un país. Te mostraremos
      búsquedas directas en varias tiendas/plataformas. No usamos enlaces de afiliado.
      Próximamente: integración con APIs oficiales para mostrar precios reales.
    </p>

    <form id="cmp-form" class="cmp" autocomplete="off">
      <input id="q" name="q" type="text" placeholder="Ej.: Xiaomi Redmi Note 13 Pro 256GB" required />
      <select id="country" name="country" required>
        <option value="ES">España</option>
        <option value="FR">Francia</option>
        <option value="DE">Alemania</option>
        <option value="IT">Italia</option>
        <option value="PT">Portugal</option>
        <option value="UK">Reino Unido</option>
        <option value="US">Estados Unidos</option>
        <option value="CA">Canadá</option>
        <option value="MX">México</option>
        <option value="BR">Brasil</option>
        <option value="AR">Argentina</option>
        <option value="CL">Chile</option>
        <option value="CO">Colombia</option>
        <option value="GLOBAL">Global</option>
      </select>
      <button type="submit">Buscar</button>
    </form>

    <div id="result" class="grid" aria-live="polite"></div>

    <p class="small" style="margin-top:1rem;">
      * Nota: Para calcular “mejor precio” real necesitaremos APIs oficiales de cada retailer/comparator.
      Esta versión sólo enlaza búsquedas públicas sin seguimiento ni afiliación.
    </p>
  </section>

  <style>
    .wrap{max-width:1100px;margin:1.3rem auto 2rem;padding:0 1rem}
    .small{color:#9fb3b8}
    form.cmp{display:flex;gap:.5rem;margin:1rem 0;flex-wrap:wrap}
    form.cmp input{flex:1;min-width:260px;padding:.8rem;border-radius:10px;border:1px solid var(--muted);background:var(--card);color:var(--text)}
    form.cmp select{padding:.8rem;border-radius:10px;border:1px solid var(--muted);background:var(--card);color:var(--text)}
    form.cmp button{padding:.8rem 1rem;border-radius:10px;background:var(--brand);color:#022;font-weight:700;border:0}
    .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));margin-top:1rem}
    .card{background:var(--card);border:1px solid var(--muted);border-radius:16px;overflow:hidden}
    .card header{display:flex;align-items:center;gap:.6rem;padding:1rem;border-bottom:1px solid var(--muted)}
    .favicon{width:18px;height:18px;border-radius:4px;background:var(--muted);display:inline-block}
    .body{padding:1rem}
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:rgba(0,196,199,.15);color:#93f7f9;font-size:.78rem}
    .btn{display:inline-block;margin-top:.6rem;padding:.55rem .8rem;background:var(--brand);color:#00292b;font-weight:700;border-radius:10px;text-decoration:none}
    .btn:hover{filter:brightness(.95)}
    .hint{font-size:.85rem;color:#9fb3b8;margin-top:.25rem}
  </style>

  <script is:inline>
    const form = document.getElementById('cmp-form');
    const result = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      result.innerHTML = '<p>Cargando…</p>';
      const q = document.getElementById('q').value.trim();
      const country = document.getElementById('country').value;

      try {
        const r = await fetch(`/api/compare?q=${encodeURIComponent(q)}&country=${country}`);
        if (!r.ok) throw new Error('Error en el comparador');
        const data = await r.json();

        if (!data.items?.length) {
          result.innerHTML = '<p>No se encontraron fuentes adecuadas para tu búsqueda.</p>';
          return;
        }

        result.innerHTML = data.items.map(item => `
          <article class="card">
            <header>
              <span class="favicon" style="background-image:url('https://www.google.com/s2/favicons?domain=${new URL(item.url).hostname}&sz=32');background-size:cover;"></span>
              <div>
                <strong>${item.store}</strong>
                <div class="hint">${new URL(item.url).hostname}</div>
              </div>
            </header>
            <div class="body">
              <span class="badge">${data.country}</span>
              <h3 style="margin:.6rem 0 .4rem">${item.title}</h3>
              <p class="small">Abriremos una búsqueda pública con los filtros correctos.</p>
              <a class="btn" href="${item.url}" target="_blank" rel="noopener nofollow">Ver resultados</a>
            </div>
          </article>
        `).join('');
      } catch (err) {
        result.innerHTML = '<p>Hubo un problema. Inténtalo de nuevo.</p>';
      }
    });
  </script>
</Base>
