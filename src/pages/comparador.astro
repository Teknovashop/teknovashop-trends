---
import Base from '../layouts/Base.astro';
---

<Base title="Comparador | Teknovashop Tendencias" description="Compara precios informativos en múltiples países y tiendas. Sin afiliación ni compra, sólo búsqueda.">
  <h1>Comparador de precios (informativo)</h1>
  <p class="small">Introduce un producto (nombre, modelo, EAN/GTIN opcional) y te generamos búsquedas directas en varias tiendas y países. <b>No vendemos ni afiliamos</b>: sólo te llevamos al buscador correspondiente.</p>

  <form id="cmp" class="cmp">
    <div class="row">
      <label>Producto</label>
      <input id="q" name="q" type="text" placeholder="Ej: Monitor 27 pulgadas 144 Hz" required />
    </div>

    <div class="row">
      <label>EAN / GTIN (opcional)</label>
      <input id="gtin" name="gtin" type="text" placeholder="Ej: 4710333871234" />
    </div>

    <div class="row">
      <label>País</label>
      <select id="cc" name="cc">
        <option value="ES" selected>España (ES)</option>
        <option value="FR">Francia (FR)</option>
        <option value="DE">Alemania (DE)</option>
        <option value="IT">Italia (IT)</option>
        <option value="GB">Reino Unido (GB)</option>
        <option value="US">Estados Unidos (US)</option>
        <option value="MX">México (MX)</option>
      </select>
    </div>

    <button class="btn" type="submit">Generar comparativas</button>
  </form>

  <section id="out" class="results" aria-live="polite"></section>

  <style>
    .cmp{margin:1rem 0 1.25rem; padding:1rem; border:1px solid var(--muted); border-radius:14px; background:var(--card);}
    .cmp .row{display:flex; gap:.75rem; align-items:center; margin:.6rem 0; flex-wrap:wrap;}
    .cmp label{min-width:150px; color:#cfe6ea; font-weight:600;}
    .cmp input,.cmp select{
      flex:1 1 320px; padding:.6rem .7rem; border-radius:10px; border:1px solid var(--muted);
      background:#0b1116; color:var(--text);
    }
    .results{margin-top:1rem; display:grid; gap:1rem; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));}
    .card{background:var(--card); border:1px solid var(--muted); border-radius:14px; padding:1rem;}
    .card h3{margin:.1rem 0 .5rem;}
    .links{display:flex; flex-direction:column; gap:.4rem;}
    .links a{display:inline-block; padding:.5rem .6rem; border:1px solid var(--muted); border-radius:10px; text-decoration:none;}
    .small{ color:#9fb3b8; }
  </style>

  <script>
    const form = document.getElementById('cmp');
    const out = document.getElementById('out');

    const tlds = {
      ES: { amazon:'es', ebay:'es', google:'es', idealo:'es', mercado:'es', pccomp:'es' },
      FR: { amazon:'fr', ebay:'fr', google:'fr', idealo:'fr' },
      DE: { amazon:'de', ebay:'de', google:'de', idealo:'de' },
      IT: { amazon:'it', ebay:'it', google:'it', idealo:'it' },
      GB: { amazon:'co.uk', ebay:'co.uk', google:'co.uk', idealo:'co.uk' },
      US: { amazon:'com', ebay:'com', google:'com', idealo:'com' },
      MX: { amazon:'com.mx', ebay:'com.mx', google:'com.mx', mercado:'com.mx' }
    };

    function enc(s){ return encodeURIComponent(s).replace(/%20/g,'+'); }

    function buildLinks(q, gtin, cc){
      const t = tlds[cc] || tlds.ES;
      const qFull = gtin ? `${q} ${gtin}` : q;

      const links = [];

      // Google Shopping
      links.push({
        group: 'Metabuscadores',
        items: [
          { label: 'Google Shopping', url: `https://www.google.${t.google}/search?tbm=shop&q=${enc(qFull)}` },
          { label: 'Búsqueda web (Google)', url: `https://www.google.${t.google}/search?q=${enc(qFull)}` }
        ]
      });

      // Marketplaces
      const mk = [];
      if (t.amazon) mk.push({ label: 'Amazon', url: `https://www.amazon.${t.amazon}/s?k=${enc(qFull)}&language=es_ES` });
      if (t.ebay)   mk.push({ label: 'eBay',   url: `https://www.ebay.${t.ebay}/sch/i.html?_nkw=${enc(qFull)}` });
      if (cc==='ES' || cc==='MX'){
        if (t.mercado) mk.push({ label: 'MercadoLibre', url: `https://listado.mercadolibre.${t.mercado}/${enc(qFull)}` });
      }
      links.push({ group: 'Marketplaces', items: mk });

      // Comparadores locales
      const comps = [];
      if (['ES','FR','DE','IT','GB'].includes(cc)){
        comps.push({ label: 'idealo', url: `https://www.idealo.${t.idealo}/search?q=${enc(qFull)}` });
      }
      if (cc==='ES'){
        comps.push({ label: 'pccomponentes (buscador)', url: `https://www.pccomponentes.${t.pccomp}/buscar/?query=${enc(qFull)}` });
      }
      links.push({ group: 'Comparadores', items: comps });

      return links.filter(g => g.items.length>0);
    }

    function render(q, gtin, cc){
      const groups = buildLinks(q, gtin, cc);
      out.innerHTML = '';
      groups.forEach(g=>{
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <h3>${g.group}</h3>
          <div class="links">
            ${g.items.map(i=>`<a target="_blank" rel="noopener noreferrer" href="${i.url}">${i.label}</a>`).join('')}
          </div>
        `;
        out.appendChild(card);
      });

      if (groups.length === 0){
        out.innerHTML = `<p class="small">Sin resultados configurados para el país seleccionado.</p>`;
      }
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = document.getElementById('q').value.trim();
      const gtin = document.getElementById('gtin').value.trim();
      const cc = document.getElementById('cc').value;
      if(!q){ out.innerHTML = '<p class="small">Escribe un término de búsqueda.</p>'; return; }
      render(q, gtin, cc);
    });
  </script>
</Base>
