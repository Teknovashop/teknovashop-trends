---
import Base from "../layouts/Base.astro";
const pageTitle = "Comparador informativo";
const pageDesc = "Busca un producto, recibes lista de tiendas con precios (informativo; sin scraping agresivo).";
---

<Base title={pageTitle} description={pageDesc}>
  <section style="display:grid;gap:1rem;max-width:980px;margin:0 auto">
    <h1 style="margin:.4rem 0 0">Comparador informativo</h1>
    <p style="color:var(--ink-soft);margin:.2rem 0 1rem">
      Pega el nombre o modelo de un producto. Mostramos precios y tiendas a partir de fuentes p√∫blicas (APIs).  
      <br/>Este comparador no usa scraping agresivo y puede no listar todas las tiendas.
    </p>

    <!-- Formulario -->
    <form id="cmp-form" class="card" on:submit="return false;" style="display:grid;gap:.6rem;padding:1rem;border:1px solid var(--muted);border-radius:12px;background:#fff">
      <label>Producto (texto) <small style="color:var(--ink-soft)">marca + modelo</small></label>
      <input id="q" placeholder="Ej. Philips 24E1N1100A, JBL Charge 5, Samsung 990 Pro..." required
        style="padding:.7rem .8rem;border:1px solid #e5e7eb;border-radius:10px"/>

      <label>Pa√≠s</label>
      <select id="country" style="padding:.6rem .8rem;border:1px solid #e5e7eb;border-radius:10px;max-width:240px">
        <option value="ES">Espa√±a (ES)</option>
        <option value="MX">M√©xico (MX)</option>
        <option value="US">Estados Unidos (US)</option>
        <option value="GB">Reino Unido (GB)</option>
        <option value="DE">Alemania (DE)</option>
        <option value="FR">Francia (FR)</option>
        <option value="IT">Italia (IT)</option>
      </select>

      <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.4rem">
        <button id="btnSearch" class="btn btn-primary" style="cursor:pointer">üîé Generar comparativa</button>
        <a class="btn btn-ghost" href="https://www.google.com/shopping" target="_blank" rel="noopener">Google Shopping</a>
        <a class="btn btn-ghost" href="https://www.idealo.es/" target="_blank" rel="noopener">Idealo</a>
        <a class="btn btn-ghost" href="https://www.pccomponentes.com/" target="_blank" rel="noopener">PcComponentes</a>
      </div>

      <small style="color:var(--ink-soft)">Nota: algunas tiendas o marketplaces pueden no aparecer si no exponen API p√∫blica o hay l√≠mites regionales.</small>
    </form>

    <!-- Resultados -->
    <section id="results" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:.8rem;margin:.4rem 0">
        <h2 style="margin:0">Resultados</h2>
        <div id="meta" style="color:var(--ink-soft);font-size:.95rem"></div>
      </div>

      <div id="warn" style="display:none;background:#fffaf0;border:1px solid #f1e3b4;color:#856404;padding:.7rem .9rem;border-radius:10px;margin:.4rem 0">
        Sugerencia: a√±ade m√°s modelo/detalle (capacidad, tama√±o, a√±o) para precisarlo.
      </div>

      <div class="table-wrap" style="overflow:auto;border:1px solid var(--muted);border-radius:12px;background:#fff">
        <table id="tbl" style="width:100%;border-collapse:collapse;font-size:.95rem">
          <thead style="background:#f7fbfe">
            <tr>
              <th style="text-align:left;padding:.65rem .75rem;border-bottom:1px solid #e5e7eb">Tienda / Vendedor</th>
              <th style="text-align:left;padding:.65rem .75rem;border-bottom:1px solid #e5e7eb">Producto</th>
              <th style="text-align:right;padding:.65rem .75rem;border-bottom:1px solid #e5e7eb;white-space:nowrap">Precio</th>
              <th style="text-align:left;padding:.65rem .75rem;border-bottom:1px solid #e5e7eb">Fuente</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Loader -->
    <div id="loading" style="display:none;align-items:center;gap:.6rem;color:var(--ink-soft)">
      <span class="spinner" style="width:16px;height:16px;border:2px solid #cfe3ea;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin 1s linear infinite"></span>
      Consultando fuentes‚Ä¶
    </div>
  </section>

  <style>
    @keyframes spin{to{transform:rotate(360deg)}}
    .price-badge{display:inline-flex;align-items:center;gap:.35rem;background:#eef6f9;border:1px solid #cfe3ea;border-radius:10px;padding:.22rem .5rem;font-weight:800}
    .src-tag{display:inline-flex;align-items:center;gap:.35rem;background:#f2f2f2;border:1px solid #e5e7eb;border-radius:8px;padding:.2rem .45rem;font-weight:700;font-size:.85rem}
    .seller{font-weight:800}
    .title{color:#0e1c22;text-decoration:none}
    .title:hover{text-decoration:underline}
  </style>

  <script is:raw>
    const fmtMoney = (n, c) => new Intl.NumberFormat(undefined, { style:'currency', currency: c || 'EUR', maximumFractionDigits: 2 }).format(n);

    const form = document.getElementById('cmp-form');
    const btn = document.getElementById('btnSearch');
    const qEl = document.getElementById('q');
    const cEl = document.getElementById('country');
    const results = document.getElementById('results');
    const loading = document.getElementById('loading');
    const tbody = document.getElementById('tbody');
    const meta = document.getElementById('meta');
    const warn = document.getElementById('warn');

    async function search(){
      const q = (qEl.value || '').trim();
      const country = cEl.value || 'ES';
      if (!q) return;

      warn.style.display = 'none';
      results.style.display = 'none';
      loading.style.display = 'flex';
      tbody.innerHTML = '';
      meta.textContent = '';

      try{
        const url = new URL('/api/compare', location.origin);
        url.searchParams.set('q', q);
        url.searchParams.set('country', country);
        const res = await fetch(url.toString());
        const data = await res.json();

        loading.style.display = 'none';
        results.style.display = 'block';

        meta.textContent = data.count ? `${data.count} ofertas encontradas` : 'Sin resultados';
        if (!data.count) warn.style.display = 'block';

        const rows = [];
        for (const it of (data.offers || [])){
          rows.push(`
            <tr>
              <td style="padding:.6rem .75rem;border-bottom:1px solid #f0f2f4">
                <div class="seller">${(it.seller || '‚Äî')}</div>
              </td>
              <td style="padding:.6rem .75rem;border-bottom:1px solid #f0f2f4">
                <a class="title" href="${it.url}" target="_blank" rel="noopener">${(it.title || '').replace(/</g,'&lt;')}</a>
              </td>
              <td style="padding:.6rem .75rem;border-bottom:1px solid #f0f2f4;text-align:right">
                <span class="price-badge">${fmtMoney(it.price, it.currency)}</span>
              </td>
              <td style="padding:.6rem .75rem;border-bottom:1px solid #f0f2f4">
                <span class="src-tag">${it.source}</span>
              </td>
            </tr>
          `);
        }
        tbody.innerHTML = rows.join('');
      }catch(e){
        loading.style.display = 'none';
        results.style.display = 'block';
        meta.textContent = 'Error al consultar fuentes';
        warn.style.display = 'block';
      }
    }

    btn.addEventListener('click', search);
    form.addEventListener('submit', search);
  </script>
</Base>
